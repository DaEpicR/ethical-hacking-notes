# Basic Dynamic Analysis

* Hunting for network signatures:

  * Need to setup all tools before running malware - if ```inetsim``` is not setup, malware may not detonate correctly.

  * On Remnux:

    ```shell
    inetsim

    # in a new tab, open wireshark gui
    sudo wireshark
    # start listening on default interface enp0s3
    ```
  
  * On FlareVM, remove the '.malz' extension from 'Malware.Unknown.exe.malz' file

  * From our static analysis earlier, we found strings related to web links and 'favicon.ico' - so on Wireshark we can use the filter ```http.request.full_uri contains favicon.ico```

  * On detonating the malware (execute it), a HTTP request is captured on Wireshark for the filter used - the full URI should match the static analysis string.

  * As always, restore the 'pre-detonation' snapshot for FlareVM.

* Host-based indicators:

  * ```procmon```, part of the Sysinternals suite, gives us information about processes - useful for getting host-based indicators.

  * We can use the ```Filter``` option to view only those processes which are related to the malware - in this case, we can filter by 'Process name' of 'Malware.Unknown.exe' and Add & Apply it.

  * Denotate the malware (while running ```inetsim``` on Remnux) - this fills up the process view.

  * This gives us fields such as ```Process Name```, ```PID```, ```Operation``` & ```Path```.

  * We can use filters such as 'Operation contains File' - shows processes which can manipulate files.

  * Based on the hints received in static analysis, we can see that a file 'C:\Users\Public\Documents\CR433101.dat.exe' is created - this is confirmed by one of the processes shown.

  * The malware may behave differently when ```inetsim``` is not running - with other hints gathered during static analysis & processes filtered using those hints, we can correlate and analyze the malware.

* Dynamic analysis of unknown binaries:

  * We can do a basic static analysis first before dynamic analysis:

    ```cmd
    floss.exe RAT.Unknown.exe.malz > floss_strings.txt
    ```
  
  * Now, upon initial detonation of malware, we just get an error box with a message.

  * To test its behavior when having an internet connection, we can run ```inetsim``` and ```sudo wireshark``` on Remnux, and then launch the malware.

  * Once executed, we can notice some activity on Wireshark - the HTTP packets can be inspected.

  * On the HTTP packets, we can also use the 'Follow Stream' option - this can give us more insight.

  * Dechaining or decoupling could be used here - the downloaded filename and the written-to-disk filename could be different.

  * Another dynamic analysis technique could be using ```procmon``` - we can use filter for process name. Run the malware again (```inetsim``` should be up).

  * We can add more filters:
  
    * Operation contains File
    * Path contains ```AppData\Roaming\Microsoft\Windows\Start Menu\Programs\Startup``` (used by malware for persistence)
    * Operation contains TCP
  
  * Another tool that can be used for dynamic analysis is ```tcpview``` - for network-based indicators on host, like an open socket for TCP connections on host.

  * In ```tcpview```, we can filter by process names as well - add a filter for the malware filename.

  * We can see that 'RAT.Unknown.exe' is listening on 0.0.0.0 at port 5555 - on Remnux, we can connect with the open socket:

    ```shell
    nc -nv 10.0.0.4 5555
    # we get a string
    ```
  
  * By decoding the base64-strings from the output received from the open socket, we can identify that it is a command execution Remote Access Trojan (bind shell).

* Analyzing a reverse shell:

  * Static analysis:

    ```cmd
    floss.exe RAT.Unknown2.exe > flossout.txt
    ```
  
  * We can use ```pestudio``` as well for static analysis.

  * For dynamic analysis, run ```inetsim``` and ```sudo wireshark``` on Remnux, then run the malware as Administrator.

  * On ```wireshark```, we get DNS queries - domain name is concatenated at runtime, so we could not find it in static analysis.

  * For the domain name, we can spoof it to get more details:

    ```cmd
    # run cmder as Administrator

    nano C:\Windows\System32\drivers\etc\hosts
    # add entry
    # 127.0.0.1 <domain name>
    # save and exit nano
    ```

  * In ```procmon```, add filters for 'Process name is RAT.Unknown2.exe' and 'Operation contains TCP' - then execute the binary again.

  * The path column gives us the port number and protocol (https) used by malware - we can now try connecting with the malware (on FlareVM):

    ```cmd
    ncat -nvlp 443
    # https port 443
    # if we run the binary again, we get a connection

    # we can run commands like 'whoami' and we get output
    # this shows that it is a reverse shell RAT
    ```
  
  * In ```procmon```, we can view the Process Tree - this shows all the parent processes & their child processes, including the processes for the reverse shell trojan.

  * We can alternatively use the 'Parent PID' filter - this shows all the child processes of malware.
